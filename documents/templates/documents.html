<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Documents</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">
    {% include 'header.html' %}

    <div class="w-full p-8">
        <div class="mx-auto bg-white rounded-lg shadow-md w-full p-6">
            <h1 class="text-4xl font-bold text-blue-900">üìÑ Documents</h1>

            <div class="mb-4">
                <button id="addDocsFromSources" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">
                    üåê Add Docs from Sources
                </button>
                <button id="extractMissingFullText" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded ml-2">
                    üì• Extract Missing Full Texts
                </button>
                <span id="addDocsResult" class="ml-4 text-sm"></span>
                <span id="extractResult" class="ml-4 text-sm"></span>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full table-fixed bg-white border border-gray-300">
                    <thead>
                        <tr class="bg-blue-900 text-white">
                            <th class="w-12 p-2 break-words">ID</th>
                            <th class="w-40 p-2 break-words">Title</th>
                            <th class="w-40 p-2 break-words">Author</th>
                            <th class="w-48 p-2 break-words">URL</th>
                            <th class="w-40 p-2 break-words">Created Date</th>
                            <th class="w-40 p-2 break-words">Updated Date</th>
                            <th class="w-64 p-2 break-words">Summary</th>
                            <th class="w-96 p-2 break-words">Full Contents</th>
                            <th class="w-40 p-2 break-words">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for document in documents %}
                        <tr id="document-{{ document.id }}">
                            <td class="w-16 p-2 break-words whitespace-normal">
                                <a href="{{ url_for('documents.view_document', id=document.id) }}" class="text-blue-600 hover:text-blue-800 underline">
                                    {{ document.id }}
                                </a>
                            </td>
                            <td class="w-48 p-2 break-words whitespace-normal">
                                <span class="document-text">{{ document.title }}</span>
                                <input type="text" class="w-full p-1 border rounded hidden document-input" value="{{ document.title }}" data-field="title">
                            </td>
                            <td class="w-48 p-2 break-words whitespace-normal">
                                <span class="document-text">{{ document.author }}</span>
                                <input type="text" class="w-full p-1 border rounded hidden document-input" value="{{ document.author }}" data-field="author">
                            </td>
                            <td class="w-64 p-2 break-words whitespace-normal">
                                <span class="document-text">{{ document.url }}</span>
                                <input type="url" class="w-full p-1 border rounded hidden document-input" value="{{ document.url }}" data-field="url">
                            </td>
                            <td class="w-48 p-2 break-words whitespace-normal">
                                {{ document.created_date.strftime('%b %d %Y @ %I:%M%p ET') if document.created_date else 'N/A' }}
                            </td>
                            <td class="w-48 p-2 break-words whitespace-normal">
                                {{ document.updated_date.strftime('%b %d %Y @ %I:%M%p ET') if document.updated_date else 'N/A' }}
                            </td>
                            <td class="w-96 p-2 break-words whitespace-normal">
                                <span class="document-text">{{ document.summary }}</span>
                                <textarea class="w-full p-1 border rounded hidden document-input" rows="3" data-field="summary">{{ document.summary }}</textarea>
                            </td>
                            <td class="w-96 p-2 break-words whitespace-normal">
                                <span class="document-text">{{ document.full_contents|default('', true)|truncate(200) }}</span>
                                <textarea class="w-full p-1 border rounded hidden document-input" rows="3" data-field="full_contents">{{ document.full_contents }}</textarea>
                            </td>
                            <td class="w-32 p-2 break-words whitespace-normal text-center">
                                <div class="flex flex-col items-center space-y-2">
                                    <button onclick="editDocument({{ document.id }})" class="w-24 inline-flex justify-center items-center bg-blue-500 hover:bg-blue-700 text-white font-bold py-1 px-2 rounded edit-btn whitespace-nowrap text-sm">
                                        üìù Edit 
                                    </button>
                                    <button onclick="saveDocument({{ document.id }})" class="w-24 inline-flex justify-center items-center bg-green-500 hover:bg-green-700 text-white font-bold py-1 px-2 rounded hidden save-btn whitespace-nowrap text-sm">
                                        üíæ Save
                                    </button>
                                    <form action="{{ url_for('documents.delete_document', id=document.id) }}" method="POST" class="inline">
                                        <button type="submit" class="w-24 inline-flex justify-center items-center bg-red-500 hover:bg-red-700 text-white font-bold py-1 px-2 rounded whitespace-nowrap text-sm">
                                            üóëÔ∏è Delete
                                        </button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
    function editDocument(id) {
        const row = document.getElementById(`document-${id}`);
        row.querySelectorAll('.document-text').forEach(el => el.classList.add('hidden'));
        row.querySelectorAll('.document-input').forEach(el => el.classList.remove('hidden'));
        row.querySelector('.edit-btn').classList.add('hidden');
        row.querySelector('.save-btn').classList.remove('hidden');
    }

    function saveDocument(id) {
    const row = document.getElementById(`document-${id}`);
    const data = {
        title: row.querySelector('[data-field="title"]').value,
        author: row.querySelector('[data-field="author"]').value,
        url: row.querySelector('[data-field="url"]').value,
        summary: row.querySelector('[data-field="summary"]').value,
        full_contents: row.querySelector('[data-field="full_contents"]').value
    };

    axios.post(`/documents/edit_document/${id}`, data)
        .then(response => {
            // Update the displayed text and hide input fields
            row.querySelectorAll('.document-input').forEach(input => {
                const textEl = input.previousElementSibling;
                textEl.textContent = input.value;
                textEl.classList.remove('hidden');
                input.classList.add('hidden');
            });
            // Update the "Updated Date" cell
            const updatedDateCell = row.querySelector('td:nth-child(6)');
            updatedDateCell.textContent = new Date().toLocaleString('en-US', { 
                month: 'short', 
                day: '2-digit', 
                year: 'numeric', 
                hour: '2-digit', 
                minute: '2-digit', 
                hour12: true 
            }) + ' ET';
            // Show edit button and hide save button
            row.querySelector('.edit-btn').classList.remove('hidden');
            row.querySelector('.save-btn').classList.add('hidden');
        })
        .catch(error => {
            console.error('Error updating document:', error);
        });
    }

    document.getElementById('extractMissingFullText').addEventListener('click', function() {
    this.disabled = true;
    this.textContent = 'üîÑ Processing...';
    document.getElementById('extractResult').textContent = '';

    fetch('/documents/extract_missing_full_text', {
        method: 'POST',
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('extractResult').textContent = data.message;
        this.textContent = 'üì• Extract Missing Full Texts';
        this.disabled = false;
    })
    .catch(error => {
        console.error('Error:', error);
        document.getElementById('extractResult').textContent = 'An error occurred';
        this.textContent = 'üì• Extract Missing Full Texts';
        this.disabled = false;
    });
});
    
document.getElementById('addDocsFromSources').addEventListener('click', function() {
    this.disabled = true;
    this.textContent = 'üîÑ Processing...';
    document.getElementById('addDocsResult').textContent = '';

    fetch('/documents/add_docs_from_sources', {
        method: 'POST',
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('addDocsResult').textContent = data.message;
        this.textContent = 'üåê Add Docs from Sources';
        this.disabled = false;
    })
    .catch(error => {
        console.error('Error:', error);
        document.getElementById('addDocsResult').textContent = 'An error occurred';
        this.textContent = 'üåê Add Docs from Sources';
        this.disabled = false;
    });
});

    
</script>
    
</body>
</html>